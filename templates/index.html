<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tushar - AI Assistant</title>

    <link rel="icon" href="../static/icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="../static/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/icons/favicon-16x16.png">
    <link rel="manifest" href="../static/site.webmanifest">
    <meta name="theme-color" content="#000000">
    <script src="https://unpkg.com/event-source-polyfill"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #matrix-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background: black; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        #scoreResult { max-height: 250px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <canvas id="matrix-bg"></canvas>

    <div class="flex-1 flex items-center justify-center p-4 pb-0 relative">
        <div class="w-full max-w-4xl mx-auto">
            <div class="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden flex flex-col h-[85vh] max-h-screen">

                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-5 sm:p-6 text-white shrink-0">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold">Tushar</h1>
                            <p class="text-sm sm:text-base opacity-90">AI Engineer & Full-Stack Developer</p>
                        </div>
                        <div class="w-12 h-12 bg-white/30 rounded-full backdrop-blur-sm"></div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 scrollbar-thin">
                    <div class="text-center">
                        <p class="inline-block bg-white/20 text-white/90 px-4 py-2 rounded-full text-sm backdrop-blur">
                            Hi! Ask about my skills, projects, or type <strong>"resume"</strong> to download my CV
                        </p>
                    </div>
                    <div class="text-center">
                        <p class="inline-block bg-white/20 text-white/90 px-4 py-2 rounded-full text-sm backdrop-blur">
                            Want to know how well your resume matches a job description?
                            Click <a id="openScoreModal" class="underline font-semibold cursor-pointer">here</a>
                        </p>
                    </div>
                </div>

                <!-- Input Form -->
                <div class="p-4 sm:p-6 border-t border-white/20 shrink-0 bg-black/10">
                    <form id="chat-form" class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="message-input" placeholder="Ask me anything..."
                            class="flex-1 px-5 py-3 sm:py-4 rounded-full bg-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-4 focus:ring-pink-500/50 transition text-base"
                            autocomplete="off" required />
                        <button type="submit"
                            class="px-8 py-3 sm:py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-full text-white font-semibold transition transform hover:scale-105 active:scale-95 shadow-lg whitespace-nowrap">
                            Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resume Score Modal -->
    <div id="scoreModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[999]">
        <div class="bg-white/10 backdrop-blur-xl p-6 rounded-2xl w-full max-w-lg border border-white/20 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Resume Match Score</h2>
                <button id="refreshBtn"
                    class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition">
                    Refresh
                </button>
            </div>

            <label class="text-white text-sm">Upload Resume (PDF)</label>
            <input id="resumeFile" type="file" accept="application/pdf"
                   class="w-full mt-1 mb-4 text-white/80 bg-white/10 px-3 py-2 rounded-xl">

            <label class="text-white text-sm">Paste Job Description</label>
            <textarea id="jobDescription" rows="5"
                      class="w-full mt-1 bg-white/10 text-white p-3 rounded-xl resize-none"></textarea>

            <!-- Analyze Button with Progress Bar Inside (NO percentage text) -->
            <button id="analyzeBtn"
                class="relative w-full mt-4 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-xl font-semibold text-white overflow-hidden transition-all duration-300">
                <span id="analyzeText" class="relative z-10">Analyze Score</span>

                <!-- Silent progress bar (no number) -->
                <div id="buttonProgressBar"
                     class="absolute inset-0 left-0 top-0 h-full bg-white/40 transition-all duration-500 ease-out"
                     style="width: 0%"></div>
            </button>

            <!-- Score Result -->
            <div id="scoreResult" class="hidden mt-6 p-5 bg-white/20 rounded-xl text-white backdrop-blur">
                <h3 class="font-bold text-xl mb-2">Match Score:</h3>
                <p id="scoreValue" class="text-5xl font-extrabold text-green-400 mb-4">--%</p>

                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-lg">Strengths</h4>
                        <ul id="strengthList" class="list-disc ml-6 text-sm opacity-90 mt-1"></ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg">Missing Skills / Weaknesses</h4>
                        <ul id="weaknessList" class="list-disc ml-6 text-sm opacity-90 mt-1"></ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg">Suggestions</h4>
                        <ul id="suggestionList" class="list-disc ml-6 text-sm opacity-90 mt-1"></ul>
                    </div>
                </div>
            </div>

            <button id="closeModal"
                class="w-full mt-4 py-3 bg-white/20 hover:bg-white/30 rounded-xl text-white font-medium transition">
                Close
            </button>
        </div>
    </div>

    <!-- Matrix Rain Animation -->
    <script>
        const canvas = document.getElementById("matrix-bg");
        const ctx = canvas.getContext("2d");
        function setupCanvas() { canvas.height = window.innerHeight; canvas.width = window.innerWidth; }
        setupCanvas();
        const chars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%^&*()*&^%";
        const fontSize = 16;
        let columns = Math.floor(canvas.width / fontSize);
        const drops = Array(columns).fill(1);

        function drawMatrix() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#0aff0a";
            ctx.font = fontSize + "px monospace";
            for (let i = 0; i < drops.length; i++) {
                const text = chars.charAt(Math.floor(Math.random() * chars.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 35);
        window.addEventListener("resize", setupCanvas);
    </script>

    <!-- Resume Score Modal Logic -->
    <script>
        // Elements
        const modal = document.getElementById("scoreModal");
        const openScore = document.getElementById("openScoreModal");
        const closeModalBtn = document.getElementById("closeModal");
        const analyzeBtn = document.getElementById("analyzeBtn");
        const refreshBtn = document.getElementById("refreshBtn");

        const scoreResult = document.getElementById("scoreResult");
        const scoreValue = document.getElementById("scoreValue");
        const strengthList = document.getElementById("strengthList");
        const weaknessList = document.getElementById("weaknessList");
        const suggestionList = document.getElementById("suggestionList");

        const analyzeText = document.getElementById("analyzeText");
        const buttonProgressBar = document.getElementById("buttonProgressBar");

        // Open / Close modal
        openScore.onclick = () => modal.classList.remove("hidden");
        closeModalBtn.onclick = () => modal.classList.add("hidden");
        modal.addEventListener("click", e => { if (e.target === modal) modal.classList.add("hidden"); });

        function displayList(id, arr) {
            const el = document.getElementById(id);
            el.innerHTML = "";
            arr = arr || [];
            if (arr.length === 0) {
                el.innerHTML = "<li class='text-gray-400'>None detected</li>";
                return;
            }
            arr.slice(0, 30).forEach(item => {
                const li = document.createElement("li");
                li.textContent = item;
                el.appendChild(li);
            });
        }

        function resetProgress() {
            buttonProgressBar.style.width = "0%";
            analyzeText.textContent = "Analyze Score";
        }

        function createSSEParser(onEvent) {
            let buf = "";
            const decoder = new TextDecoder();
            return {
                feed(chunk) {
                    buf += decoder.decode(chunk, { stream: true });
                    let parts = buf.split("\n\n");
                    buf = parts.pop();
                    for (let part of parts) {
                        const lines = part.split(/\r?\n/);
                        for (let line of lines) {
                            if (line.startsWith("data:")) {
                                try { onEvent(JSON.parse(line.slice(5).trim())); } catch (e) {}
                            }
                        }
                    }
                },
                flush() {
                    if (buf) {
                        const lines = buf.split(/\r?\n/);
                        for (let line of lines) {
                            if (line.startsWith("data:")) {
                                try { onEvent(JSON.parse(line.slice(5).trim())); } catch (e) {}
                            }
                        }
                        buf = "";
                    }
                }
            };
        }

        async function analyzeResume(e) {
            e?.preventDefault();

            const fileInput = document.getElementById("resumeFile");
            const jobDesc = document.getElementById("jobDescription").value.trim();

            if (!fileInput.files.length || !jobDesc) {
                alert("Please upload your resume and paste a job description.");
                return;
            }

            // Reset UI
            scoreResult.classList.add("hidden");
            scoreValue.textContent = "--%";
            strengthList.innerHTML = "";
            weaknessList.innerHTML = "";
            suggestionList.innerHTML = "";
            resetProgress();

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("job_description", jobDesc);

            let response;
            try {
                response = await fetch("/resume-progress", { method: "POST", body: formData });
            } catch (err) {
                alert("Network error. Check console.");
                console.error(err);
                return;
            }

            if (!response.ok || !response.body) {
                alert("Server error: " + response.status);
                return;
            }

            const reader = response.body.getReader();
            const sse = createSSEParser(obj => {
                if (typeof obj.progress === "number") {
                    const p = Math.min(100, Math.round(obj.progress));
                    buttonProgressBar.style.width = p + "%";

                    // Change text while processing
                    analyzeText.textContent = (p > 0 && p < 100) ? "Analyzing..." : "Analyze Score";
                }

                if (obj.progress === 100) {
                    scoreResult.classList.remove("hidden");
                    const finalScore = obj.final_score ?? obj.score ?? 0;
                    scoreValue.textContent = finalScore + "%";

                    displayList("strengthList", obj.matched_skills || obj.strengths);
                    displayList("weaknessList", obj.missing_skills || obj.weaknesses);
                    displayList("suggestionList", obj.missing_keywords || obj.suggestions);
                }
            });

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    sse.feed(value);
                }
                sse.flush();
            } catch (err) {
                console.error("Stream error:", err);
            } finally {
                reader.releaseLock?.();
            }
        }

        // Event Listeners
        analyzeBtn.addEventListener("click", analyzeResume);

        refreshBtn.onclick = () => {
            document.getElementById("jobDescription").value = "";
            scoreResult.classList.add("hidden");
            resetProgress();
            scoreValue.textContent = "--%";
            strengthList.innerHTML = "";
            weaknessList.innerHTML = "";
            suggestionList.innerHTML = "";
        };
    </script>

    <script src="/static/script.js"></script>
</body>
</html>