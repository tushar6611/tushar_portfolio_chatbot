<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tushar - AI Assistant</title>

    <link rel="icon" href="../static/icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="../static/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/icons/favicon-16x16.png">
    <link rel="manifest" href="../static/site.webmanifest">
    <meta name="theme-color" content="#000000">

    <script src="https://unpkg.com/event-source-polyfill"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .bg-cinema {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a0d1a 35%, #0d0a1a 100%);
            background-size: 200% 200%;
            animation: gradientShift 25s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .glass-card {
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .netflix-red { background-color: #E50914; }
        .netflix-red-hover:hover { background-color: #c30711; }
        .glow-red { box-shadow: 0 0 40px rgba(229, 9, 20, 0.5); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        #particles-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .custom-cursor {
            position: fixed;
            width: 24px; height: 24px;
            border: 2px solid rgba(229, 9, 20, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: transform 0.15s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-cinema text-white">

    <!-- HBO Max Interactive Particles -->
    <canvas id="particles-canvas"></canvas>
    <div class="custom-cursor" id="cursor"></div>

    <div class="flex-1 flex items-center justify-center p-4 relative z-10">
        <div class="w-full max-w-5xl mx-auto">
            <div class="glass-card rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[88vh] glow-red">

                <div class="netflix-red p-6 sm:p-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl sm:text-4xl font-black tracking-tight">Tushar</h1>
                            <p class="text-sm sm:text-base opacity-90 mt-1">AI Engineer & Full-Stack Developer</p>
                        </div>
                        <div class="w-16 h-16 bg-white/30 rounded-full backdrop-blur-sm border border-white/20"></div>
                    </div>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-6 sm:p-8 space-y-6 scrollbar-thin">
                    <div class="text-center">
                        <p class="inline-block bg-white/10 px-6 py-3 rounded-full text-sm backdrop-blur border border-white/10">
                            Hi! Ask about my skills, projects, or type <strong class="text-red-400">"resume"</strong> to download my CV
                        </p>
                    </div>
                    <div class="text-center">
                        <p class="inline-block bg-white/10 px-6 py-3 rounded-full text-sm backdrop-blur border border-white/10">
                            Want to know how well your resume matches a job description?<br class="sm:hidden"/>
                            Click <a id="openScoreModal" class="underline font-bold text-red-400 hover:text-red-300 cursor-pointer">here</a>
                        </p>
                    </div>
                </div>

                <div class="p-5 sm:p-7 border-t border-white/10 bg-black/40">
                    <form id="chat-form" class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="message-input" placeholder="Ask me anything..."
                            class="flex-1 px-6 py-4 rounded-full bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-red-500 focus:ring-4 focus:ring-red-500/30 transition text-base"
                            autocomplete="off" required />
                        <button type="submit"
                            class="px-10 py-4 netflix-red netflix-red-hover text-white font-bold rounded-full transition transform hover:scale-105 active:scale-95 shadow-lg glow-red">
                            Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resume Score Modal -->
    <div id="scoreModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-2xl flex items-center justify-center z-50 p-4">
        <div class="bg-black/80 backdrop-blur-2xl rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 shadow-2xl border border-red-900/30 glow-red">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl sm:text-3xl font-black">Resume Match Score</h2>
                <button id="closeModal" class="text-4xl text-gray-400 hover:text-white transition">&times;</button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-2">Upload Resume (PDF)</label>
                    <input id="resumeFile" type="file" accept="application/pdf"
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-red-600 file:text-white hover:file:bg-red-700 cursor-pointer">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Paste Job Description</label>
                    <textarea id="jobDescription" rows="6"
                              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 resize-none focus:outline-none focus:border-red-500 focus:ring-4 focus:ring-red-500/30 transition"></textarea>
                </div>
                <button id="analyzeBtn"
                    class="relative w-full py-5 netflix-red netflix-red-hover rounded-xl font-bold text-white overflow-hidden transition-all duration-300 shadow-lg">
                    <span id="analyzeText" class="relative z-10 text-lg">Analyze Score</span>
                    <div id="buttonProgressBar"
                         class="absolute inset-0 left-0 top-0 h-full bg-white/30 transition-all duration-500 ease-out"
                         style="width: 0%"></div>
                </button>
                <div id="scoreResult" class="hidden mt-6 p-6 bg-white/10 rounded-2xl border border-white/10">
                    <h3 class="text-2xl font-bold mb-3">Match Score</h3>
                    <p id="scoreValue" class="text-6xl font-extrabold text-red-500 mb-6">--%</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <div><h4 class="font-bold text-red-400 mb-2">Strengths</h4><ul id="strengthList" class="list-disc ml-5 space-y-1 text-gray-300"></ul></div>
                        <div><h4 class="font-bold text-orange-400 mb-2">Missing Skills</h4><ul id="weaknessList" class="list-disc ml-5 space-y-1 text-gray-300"></ul></div>
                        <div><h4 class="font-bold text-cyan-400 mb-2">Suggestions</h4><ul id="suggestionList" class="list-disc ml-5 space-y-1 text-gray-300"></ul></div>
                    </div>
                </div>
                <button id="refreshBtn" class="w-full py-4 bg-white/10 hover:bg-white/20 rounded-xl font-medium transition mt-4">
                    Clear & Start Over
                </button>
            </div>
        </div>
    </div>

    <!-- Particles + All Logic -->
    <script>
        // === Particles System ===
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        const mouse = { x: 0, y: 0 };
        const cursor = document.getElementById('cursor');

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resize();
        window.addEventListener('resize', resize);

        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 0.6 - 0.3;
                this.speedY = Math.random() * 0.6 - 0.3;
                this.opacity = 0.3;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                const dx = mouse.x - this.x;
                const dy = mouse.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 160) {
                    const force = 160 / (dist * dist);
                    this.speedX += dx * force * 0.0006;
                    this.speedY += dy * force * 0.0006;
                    this.opacity = Math.min(0.9, this.opacity + 0.02);
                } else {
                    this.opacity = Math.max(0.2, this.opacity - 0.005);
                }
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = `rgba(229, 50, 60, ${this.opacity})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = `rgba(255, 120, 130, ${this.opacity * 0.4})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 0.5, 0, Math.PI * 2); ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            const count = Math.min(90, window.innerWidth / 14);
            for (let i = 0; i < count; i++) particles.push(new Particle());
        }
        initParticles();
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
        window.addEventListener('resize', () => { resize(); initParticles(); });

        // === Modal & Resume Logic (unchanged from your working version) ===
        const modal = document.getElementById("scoreModal");
        const openScore = document.getElementById("openScoreModal");
        const closeModalBtn = document.getElementById("closeModal");

        openScore.onclick = () => modal.classList.remove("hidden");
        closeModalBtn.onclick = () => modal.classList.add("hidden");
        modal.addEventListener("click", e => { if (e.target === modal) modal.classList.add("hidden"); });

        function displayList(id, arr) {
            const el = document.getElementById(id);
            el.innerHTML = "";
            arr = arr || [];
            if (arr.length === 0) { el.innerHTML = "<li class='text-gray-500 italic'>None detected</li>"; return; }
            arr.slice(0, 15).forEach(item => {
                const li = document.createElement("li");
                li.textContent = item;
                li.className = "leading-relaxed";
                el.appendChild(li);
            });
        }

        function resetProgress() {
            document.getElementById("buttonProgressBar").style.width = "0%";
            document.getElementById("analyzeText").textContent = "Analyze Score";
        }

        function createSSEParser(onEvent) {
            let buf = ""; const decoder = new TextDecoder();
            return {
                feed(chunk) {
                    buf += decoder.decode(chunk, { stream: true });
                    let parts = buf.split("\n\n"); buf = parts.pop();
                    for (let part of parts) {
                        const lines = part.split(/\r?\n/);
                        for (let line of lines) {
                            if (line.startsWith("data:")) {
                                try { onEvent(JSON.parse(line.slice(5).trim())); } catch (e) {}
                            }
                        }
                    }
                },
                flush() {
                    if (buf) {
                        const lines = buf.split(/\r?\n/);
                        for (let line of lines) {
                            if (line.startsWith("data:")) {
                                try { onEvent(JSON.parse(line.slice(5).trim())); } catch (e) {}
                            }
                        }
                        buf = "";
                    }
                }
            };
        }

        async function analyzeResume(e) {
            e?.preventDefault();
            const fileInput = document.getElementById("resumeFile");
            const jobDesc = document.getElementById("jobDescription").value.trim();
            if (!fileInput.files.length || !jobDesc) {
                alert("Please upload your resume (PDF) and paste a job description.");
                return;
            }
            document.getElementById("scoreResult").classList.add("hidden");
            document.getElementById("scoreValue").textContent = "--%";
            ["strengthList", "weaknessList", "suggestionList"].forEach(id => document.getElementById(id).innerHTML = "");
            resetProgress();

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("job_description", jobDesc);

            let response;
            try { response = await fetch("/resume-progress", { method: "POST", body: formData }); }
            catch (err) { alert("Network error."); console.error(err); return; }

            if (!response.ok || !response.body) { alert("Server error: " + response.status); return; }

            const reader = response.body.getReader();
            const sse = createSSEParser(obj => {
                if (typeof obj.progress === "number") {
                    const p = Math.min(100, Math.round(obj.progress));
                    document.getElementById("buttonProgressBar").style.width = p + "%";
                    document.getElementById("analyzeText").textContent = p < 100 ? "Analyzing..." : "Analyze Score";
                }
                if (obj.progress === 100) {
                    document.getElementById("scoreResult").classList.remove("hidden");
                    const finalScore = obj.final_score ?? obj.score ?? 0;
                    document.getElementById("scoreValue").textContent = finalScore + "%";
                    displayList("strengthList", obj.matched_skills || obj.strengths);
                    displayList("weaknessList", obj.missing_skills || obj.weaknesses);
                    displayList("suggestionList", obj.missing_keywords || obj.suggestions);
                }
            });

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    sse.feed(value);
                }
                sse.flush();
            } catch (err) { console.error("Stream error:", err); }
        }

        document.getElementById("analyzeBtn").addEventListener("click", analyzeResume);
        document.getElementById("refreshBtn").onclick = () => {
            document.getElementById("resumeFile").value = "";
            document.getElementById("jobDescription").value = "";
            document.getElementById("scoreResult").classList.add("hidden");
            resetProgress();
            document.getElementById("scoreValue").textContent = "--%";
            ["strengthList", "weaknessList", "suggestionList"].forEach(id => document.getElementById(id).innerHTML = "");
        };
    </script>

    <script src="/static/script.js"></script>
</body>
</html>